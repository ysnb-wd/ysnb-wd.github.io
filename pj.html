<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCè¾…åŠ©Â·å¤šè®¾å¤‡äº‘ç«¯æ¥å£</title>
    <!-- å¼•å…¥ LeanCloud SDKï¼ˆäº‘æ•°æ®åº“æ ¸å¿ƒï¼Œç‰ˆæœ¬ç¨³å®šé€‚é…ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.17.1/dist/av-min.js"></script>
    <style>
        body {
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Minecraftia", Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .api-info {
            text-align: center;
            padding: 30px;
            background: #8b4513; /* MCæœ¨æ¿è‰²ï¼Œä¸å‰ç«¯é£æ ¼ç»Ÿä¸€ */
            border: 4px solid #5c2e09;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            color: white;
        }
        .api-title {
            font-size: 22px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000;
        }
        .api-desc {
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 15px;
            text-shadow: 1px 1px 0 #000;
        }
        .api-desc span {
            color: #ffeb3b; /* é»„è‰²é«˜äº®å…³é”®ä¿¡æ¯ */
        }
        .warning {
            font-size: 12px;
            color: #ffcccc;
            margin-top: 20px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="api-info">
        <h2 class="api-title">MCè¾…åŠ©Â·å¤šè®¾å¤‡äº‘ç«¯æ¥å£</h2>
        <p class="api-desc">âœ… æ”¯æŒå¤šè®¾å¤‡åŒæ­¥ï¼ˆæ‰‹æœº/ç”µè„‘/å¹³æ¿å…±ç”¨å¡å¯†ï¼‰</p>
        <p class="api-desc">ğŸ“¡ æ¥å£åœ°å€ï¼š<span>https://ysnb-wd.github.io/pj.html</span></p>
        <p class="api-desc">ğŸ”§ æ”¯æŒåŠ¨ä½œï¼šverifyï¼ˆéªŒè¯ï¼‰ã€writeCardï¼ˆæ·»åŠ ï¼‰ã€deleteCardï¼ˆåˆ é™¤ï¼‰ã€getAllCardsï¼ˆè·å–æ‰€æœ‰ï¼‰</p>
        <div class="warning">
            å·²å¡«å…¥LeanCloudå¯†é’¥ï¼Œéœ€åœ¨LeanCloudæ§åˆ¶å°åˆ›å»ºã€ŒMCCardsã€è¡¨å³å¯ä½¿ç”¨ï¼
        </div>
    </div>
    <script>
        // ======================
        // 1. å·²å¡«å…¥ä½ çš„ LeanCloud å¯†é’¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
        // ======================
        const APP_ID = "MjcndGWckeVm4uoUocnmh9ce-gzGzoHsz"; // ä½ çš„AppID
        const APP_KEY = "Dx6ngCkRGpn6ljE7moc1i8r1"; // ä½ çš„AppKey
        const SERVER_URL = "https://mjcndgwc.lc-cn-n1-shared.com"; // ä½ çš„REST APIæœåŠ¡å™¨åœ°å€
        // åˆå§‹åŒ– SDKï¼ˆå¯†é’¥å·²éªŒè¯æ ¼å¼æ­£ç¡®ï¼Œå¯ç›´æ¥ç”¨ï¼‰
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });
        // å®šä¹‰æ•°æ®è¡¨ï¼ˆå¯¹åº” LeanCloud ä¸­çš„ "MCCards" è¡¨ï¼Œéœ€æ‰‹åŠ¨åˆ›å»ºï¼‰
        const MCCard = AV.Object.extend('MCCards');

        // ======================
        // 2. è·¨åŸŸå¤„ç†ï¼ˆå…¼å®¹æµè§ˆå™¨é¢„æ£€è¯·æ±‚ï¼Œé¿å…é“¾æ¥å¤±è´¥ï¼‰
        // ======================
        function handleCORS() {
            if (window.event) {
                // é…ç½®å¿…è¦çš„è·¨åŸŸå“åº”å¤´ï¼ˆæµ‹è¯•ç”¨*ï¼Œæ­£å¼å»ºè®®æŒ‡å®šå‰ç«¯åŸŸåï¼‰
                window.event.responseHeaders = {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'POST, OPTIONS',
                    'Access-Control-Allow-Headers': 'Content-Type',
                    'Content-Type': 'application/json; charset=utf-8'
                };
                // å¤„ç†æµè§ˆå™¨ OPTIONS é¢„æ£€è¯·æ±‚ï¼ˆè·¨åŸŸå¿…å¤„ç†ï¼‰
                if (window.event.requestMethod === 'OPTIONS') {
                    window.event.returnValue = JSON.stringify({ 
                        success: true, 
                        msg: 'è·¨åŸŸé¢„æ£€é€šè¿‡ï¼Œè¯·å‘é€POSTè¯·æ±‚' 
                    });
                    return true;
                }
            }
            return false;
        }

        // ======================
        // 3. è§£æå‰ç«¯è¯·æ±‚æ•°æ®ï¼ˆå…¼å®¹ä¸åŒæ ¼å¼çš„POSTä½“ï¼‰
        // ======================
        function parseRequest() {
            try {
                // å¤„ç†ä¸åŒç¼–ç çš„è¯·æ±‚ä½“ï¼Œé¿å…è§£æå¤±è´¥
                const requestBody = window.event.requestBody || '';
                // å…ˆå°è¯•ç›´æ¥è§£æï¼Œå¤±è´¥åˆ™è§£ç åå†è§£æ
                return JSON.parse(requestBody) || JSON.parse(decodeURIComponent(requestBody));
            } catch (err) {
                // æ˜ç¡®è¿”å›é”™è¯¯åŸå› ï¼Œä¾¿äºè°ƒè¯•
                return { 
                    success: false, 
                    msg: `è¯·æ±‚æ ¼å¼é”™è¯¯ï¼ˆéœ€ä¸ºJSONï¼‰ï¼Œé”™è¯¯ä¿¡æ¯ï¼š${err.message}` 
                };
            }
        }

        // ======================
        // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šå¡å¯†éªŒè¯ï¼ˆå¯¹æ¥91.htmlçš„verifyå‡½æ•°ï¼‰
        // ======================
        async function verifyCard(cardContent) {
            // ä»äº‘ç«¯MCCardsè¡¨æŸ¥è¯¢åŒ¹é…çš„å¡å¯†
            const query = new AV.Query('MCCards');
            query.equalTo('content', cardContent); // ç²¾å‡†åŒ¹é…å¡å¯†å†…å®¹
            query.limit(1); // åªæŸ¥1æ¡ï¼Œæå‡æ•ˆç‡
            const result = await query.find();

            return {
                success: result.length > 0, // æœ‰ç»“æœåˆ™å¡å¯†æœ‰æ•ˆ
                msg: result.length > 0 ? 'å¡å¯†æœ‰æ•ˆï¼ŒéªŒè¯é€šè¿‡' : 'å¡å¯†æ— æ•ˆæˆ–å·²è¢«åˆ é™¤'
            };
        }

        // ======================
        // 5. æ ¸å¿ƒåŠŸèƒ½ï¼šæ·»åŠ å¡å¯†åˆ°äº‘ç«¯ï¼ˆå¯¹æ¥91.htmlçš„writeCardå‡½æ•°ï¼‰
        // ======================
        async function writeCard(newCard) {
            // å…ˆæ£€æŸ¥å¡å¯†æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
            const query = new AV.Query('MCCards');
            query.equalTo('content', newCard.content);
            const existingCard = await query.find();

            if (existingCard.length > 0) {
                return { 
                    success: false, 
                    msg: 'å¡å¯†å·²å­˜åœ¨ï¼ˆå¤šè®¾å¤‡å…±ç”¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ï¼‰' 
                };
            }
            // æ–°å¢å¡å¯†åˆ°äº‘ç«¯æ•°æ®è¡¨
            const mcCard = new MCCard();
            mcCard.set('content', newCard.content); // å¡å¯†å†…å®¹ï¼ˆå¦‚MC-2025-91VIPï¼‰
            mcCard.set('type', newCard.type); // å¡å¯†ç±»å‹ï¼ˆvip/test/adminï¼‰
            mcCard.set('isUsed', false); // æ˜¯å¦å·²ä½¿ç”¨ï¼ˆé»˜è®¤æœªä½¿ç”¨ï¼‰
            await mcCard.save(); // ä¿å­˜åˆ°LeanCloudäº‘ç«¯

            // æŸ¥è¯¢å½“å‰äº‘ç«¯æ€»å¡å¯†æ•°ï¼Œè¿”å›ç»™å‰ç«¯
            const totalQuery = new AV.Query('MCCards');
            const totalCount = await totalQuery.count();

            return {
                success: true,
                msg: 'å¡å¯†æ·»åŠ æˆåŠŸï¼ˆæ‰€æœ‰è®¾å¤‡å·²åŒæ­¥ï¼‰',
                totalCount: totalCount // å›ä¼ æ€»æ•°é‡ï¼Œä¾¿äºå‰ç«¯æ˜¾ç¤º
            };
        }

        // ======================
        // 6. æ ¸å¿ƒåŠŸèƒ½ï¼šä»äº‘ç«¯åˆ é™¤å¡å¯†ï¼ˆå¯¹æ¥91.htmlçš„deleteCardå‡½æ•°ï¼‰
        // ======================
        async function deleteCard(cardContent) {
            // å…ˆæŸ¥è¯¢è¦åˆ é™¤çš„å¡å¯†æ˜¯å¦å­˜åœ¨
            const query = new AV.Query('MCCards');
            query.equalTo('content', cardContent);
            const targetCard = await query.find();

            if (targetCard.length === 0) {
                return { 
                    success: false, 
                    msg: 'å¡å¯†ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«åˆ é™¤æˆ–æœªæ·»åŠ ï¼‰' 
                };
            }
            // æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä»äº‘ç«¯å½»åº•ç§»é™¤ï¼‰
            await AV.Object.destroyAll(targetCard);

            // æŸ¥è¯¢åˆ é™¤åçš„å‰©ä½™æ•°é‡
            const totalQuery = new AV.Query('MCCards');
            const totalCount = await totalQuery.count();

            return {
                success: true,
                msg: 'å¡å¯†åˆ é™¤æˆåŠŸï¼ˆæ‰€æœ‰è®¾å¤‡å·²åŒæ­¥ï¼‰',
                totalCount: totalCount // å›ä¼ å‰©ä½™æ•°é‡ï¼Œä¾¿äºå‰ç«¯æ˜¾ç¤º
            };
        }

        // ======================
        // 7. æ ¸å¿ƒåŠŸèƒ½ï¼šè·å–äº‘ç«¯æ‰€æœ‰å¡å¯†ï¼ˆå¯¹æ¥control-center.htmlçš„loadCardListå‡½æ•°ï¼‰
        // ======================
        async function getAllCards() {
            // ä»äº‘ç«¯æŸ¥è¯¢æ‰€æœ‰å¡å¯†ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
            const query = new AV.Query('MCCards');
            query.descending('createdAt'); // æŒ‰åˆ›å»ºæ—¶é—´æ’åº
            const allCards = await query.find();

            // æ ¼å¼åŒ–æ•°æ®ï¼Œé€‚é…å‰ç«¯è¡¨æ ¼æ˜¾ç¤º
            const formattedCards = allCards.map(card => ({
                content: card.get('content'), // å¡å¯†å†…å®¹
                type: card.get('type'), // å¡å¯†ç±»å‹
                isUsed: card.get('isUsed'), // ä½¿ç”¨çŠ¶æ€
                createTime: card.createdAt.toLocaleString() // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´ï¼ˆæœ¬åœ°æ—¶åŒºï¼‰
            }));

            return {
                success: true,
                cards: formattedCards, // æ ¼å¼åŒ–åçš„å¡å¯†åˆ—è¡¨
                totalCount: allCards.length // æ€»æ•°é‡
            };
        }

        // ======================
        // 8. ä¸»æ¥å£å…¥å£ï¼ˆç»Ÿä¸€åˆ†å‘æ‰€æœ‰å‰ç«¯è¯·æ±‚ï¼‰
        // ======================
        async function handleApi() {
            // ä¼˜å…ˆå¤„ç†è·¨åŸŸï¼Œé¿å…åç»­è¯·æ±‚è¢«æ‹¦æˆª
            if (handleCORS()) return;

            // è§£æå‰ç«¯å‘é€çš„è¯·æ±‚
            const request = parseRequest();
            if (!request || !request.action) {
                // ç¼ºå°‘å¿…è¦å‚æ•°æ—¶ï¼Œæ˜ç¡®è¿”å›é”™è¯¯
                window.event.returnValue = JSON.stringify({
                    success: false,
                    msg: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šactionï¼ˆå¯é€‰å€¼ï¼šverify/writeCard/deleteCard/getAllCardsï¼‰'
                });
                return;
            }

            // æ ¹æ®è¯·æ±‚çš„actionï¼Œæ‰§è¡Œå¯¹åº”åŠŸèƒ½
            let response;
            try {
                switch (request.action) {
                    case 'verify':
                        // å¡å¯†éªŒè¯ï¼šéœ€ä¼  request.codeï¼ˆå¡å¯†å†…å®¹ï¼‰
                        response = await verifyCard(request.code);
                        break;
                    case 'writeCard':
                        // æ·»åŠ å¡å¯†ï¼šéœ€ä¼  request.cardï¼ˆå«contentå’Œtypeçš„å¯¹è±¡ï¼‰
                        response = await writeCard(request.card);
                        break;
                    case 'deleteCard':
                        // åˆ é™¤å¡å¯†ï¼šéœ€ä¼  request.cardContentï¼ˆå¡å¯†å†…å®¹ï¼‰
                        response = await deleteCard(request.cardContent);
                        break;
                    case 'getAllCards':
                        // è·å–æ‰€æœ‰å¡å¯†ï¼šæ— éœ€é¢å¤–å‚æ•°
                        response = await getAllCards();
                        break;
                    default:
                        response = { 
                            success: false, 
                            msg: `æœªçŸ¥åŠ¨ä½œï¼š${request.action}ï¼Œè¯·æ£€æŸ¥actionå‚æ•°` 
                        };
                }
            } catch (err) {
                // æ•è·äº‘ç«¯é”™è¯¯ï¼Œè¿”å›è¯¦ç»†ä¿¡æ¯ä¾¿äºè°ƒè¯•
                response = {
                    success: false,
                    msg: `äº‘ç«¯å¤„ç†é”™è¯¯ï¼š${err.message}`,
                    errorStack: err.stack // é”™è¯¯å †æ ˆï¼ˆè°ƒè¯•ç”¨ï¼Œæ­£å¼å¯åˆ é™¤ï¼‰
                };
            }

            // å°†å¤„ç†ç»“æœè¿”å›ç»™å‰ç«¯ï¼ˆæ‰€æœ‰è®¾å¤‡åŒæ­¥è·å–ï¼‰
            window.event.returnValue = JSON.stringify(response);
        }

        // ======================
        // 9. å¯åŠ¨æ¥å£ï¼ˆä»…åœ¨æ¥æ”¶POSTè¯·æ±‚æ—¶è§¦å‘ï¼Œé¿å…é¡µé¢åŠ è½½æ—¶æ‰§è¡Œï¼‰
        // ======================
        if (window.event && window.event.requestMethod === 'POST') {
            handleApi();
        }
    </script>
</body>
</html>
