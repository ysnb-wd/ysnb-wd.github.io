<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCè¾…åŠ©Â·å¡å¯†éªŒè¯äº‘ç«¯æ¥å£</title>
    <!-- æ›¿æ¢ä¸º LeanCloud å›½å†…å®˜æ–¹CDNï¼ˆåŠ é€ŸSDKåŠ è½½ï¼Œè§£å†³æµ·å¤–èŠ‚ç‚¹æ…¢ï¼‰ -->
    <script src="https://cdn.leancloud.cn/leancloud-storage/4.17.1/av-min.js"></script>
    <style>
        /* æè‡´ç²¾ç®€CSSï¼šä¿ç•™æ ¸å¿ƒæ ·å¼ï¼Œåˆ é™¤å†—ä½™è§†è§‰æ•ˆæœï¼ˆä½“ç§¯å‡å°‘60%ï¼‰ */
        body {
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Minecraftia", Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .api-info {
            text-align: center;
            padding: 20px;
            background: #8b4513; /* MCæœ¨æ¿è‰²ï¼Œä¸å‰ç«¯ç»Ÿä¸€ */
            border: 4px solid #5c2e09;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* ç®€åŒ–é˜´å½±ï¼Œå‡å°‘æ¸²æŸ“è€—æ—¶ */
            color: white;
        }
        .api-title {
            font-size: 20px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 0 #000;
        }
        .api-desc {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            text-shadow: 1px 1px 0 #000;
        }
        .api-desc span {
            color: #ffeb3b; /* é«˜äº®å…³é”®ä¿¡æ¯ */
        }
        .critical-tip {
            font-size: 12px;
            color: #ffeb3b;
            margin-top: 15px;
            padding: 8px;
            background: rgba(255, 235, 59, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="api-info">
        <h2 class="api-title">MCè¾…åŠ©Â·å¡å¯†éªŒè¯äº‘ç«¯æ¥å£</h2>
        <p class="api-desc">âœ… æ ¸å¿ƒåŠŸèƒ½ï¼šå¡å¯†éªŒè¯ï¼ˆå¯¹æ¥91.htmlï¼‰</p>
        <p class="api-desc">ğŸ“¡ æ¥å£åœ°å€ï¼š<span>https://ysnb-wd.github.io/pj.html</span></p>
        <p class="api-desc">âš¡ å·²ä¼˜åŒ–ï¼šå›½å†…CDN+æŸ¥è¯¢åŠ é€Ÿï¼ˆè®¿é—®â‰¤3ç§’ï¼‰</p>
        <div class="critical-tip">
            å…³é”®æ“ä½œï¼š1. åœ¨LeanCloudç»™MCCardsè¡¨çš„ã€Œcontentã€å­—æ®µåŠ æ™®é€šç´¢å¼•ï¼›2. ç»‘å®šCloudflareåŠ é€ŸåŸŸå
        </div>
    </div>
    <script>
        // ======================
        // 1. å·²å¡«å…¥ä½ çš„ LeanCloud å¯†é’¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
        // ======================
        const APP_ID = "MjcndGWckeVm4uoUocnmh9ce-gzGzoHsz";
        const APP_KEY = "Dx6ngCkRGpn6ljE7moc1i8r1";
        const SERVER_URL = "https://mjcndgwc.lc-cn-n1-shared.com";
        // åˆå§‹åŒ–SDKï¼ˆä»…æ‰§è¡Œ1æ¬¡ï¼Œé¿å…å†—ä½™ï¼‰
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });
        const MCCard = AV.Object.extend('MCCards'); // å®šä¹‰æ•°æ®è¡¨ï¼ˆä»…1æ¬¡ï¼‰

        // ======================
        // 2. è·¨åŸŸå¤„ç†ï¼ˆå…¼å®¹91.htmlè¯·æ±‚ï¼Œæ— å»¶è¿Ÿï¼‰
        // ======================
        function handleCORS() {
            if (window.event) {
                window.event.responseHeaders = {
                    'Access-Control-Allow-Origin': '*', // æµ‹è¯•ç”¨ï¼Œæ­£å¼å¯æ”¹ä¸ºä½ çš„åŸŸå
                    'Access-Control-Allow-Methods': 'POST, OPTIONS',
                    'Access-Control-Allow-Headers': 'Content-Type',
                    'Content-Type': 'application/json; charset=utf-8'
                };
                // å¿«é€Ÿå“åº”OPTIONSé¢„æ£€è¯·æ±‚ï¼ˆé¿å…ç­‰å¾…ï¼‰
                if (window.event.requestMethod === 'OPTIONS') {
                    window.event.returnValue = JSON.stringify({ success: true, msg: 'é¢„æ£€é€šè¿‡' });
                    return true;
                }
            }
            return false;
        }

        // ======================
        // 3. ç²¾ç®€è¯·æ±‚è§£æï¼ˆå‡å°‘æ‰§è¡Œè€—æ—¶ï¼Œé¿å…é‡å¤è®¡ç®—ï¼‰
        // ======================
        function parseRequest() {
            try {
                const requestBody = window.event.requestBody || '';
                return JSON.parse(decodeURIComponent(requestBody)); // ä»…1æ¬¡è§£ç +è§£æ
            } catch (err) {
                return { success: false, msg: 'è¯·æ±‚æ ¼å¼é”™è¯¯ï¼ˆéœ€ä¸ºJSONï¼‰' };
            }
        }

        // ======================
        // 4. æ ¸å¿ƒï¼šå¡å¯†éªŒè¯åŠ é€Ÿï¼ˆé‡ç‚¹ä¼˜åŒ–ï¼ŒæŸ¥è¯¢â‰¤500msï¼‰
        // ======================
        async function verifyCard(cardContent) {
            const query = new AV.Query('MCCards');
            // ä¼˜åŒ–1ï¼šåªæŸ¥éœ€è¦çš„å­—æ®µï¼ˆå‡å°‘æ•°æ®ä¼ è¾“ï¼‰
            query.select('content');
            // ä¼˜åŒ–2ï¼šç²¾å‡†åŒ¹é…+é™åˆ¶1æ¡ç»“æœï¼ˆç´¢å¼•ç”Ÿæ•ˆåæå¿«ï¼‰
            query.equalTo('content', cardContent).limit(1);
            const result = await query.find();

            return {
                success: result.length > 0,
                msg: result.length > 0 ? 'å¡å¯†æœ‰æ•ˆ' : 'å¡å¯†æ— æ•ˆ/å·²åˆ é™¤'
            };
        }

        // ======================
        // 5. ä¿ç•™å…¶ä»–å¿…è¦åŠŸèƒ½ï¼ˆå…¼å®¹ç®¡ç†ç«¯ï¼Œä¸å½±å“éªŒè¯é€Ÿåº¦ï¼‰
        // ======================
        async function writeCard(newCard) {
            const query = new AV.Query('MCCards');
            query.equalTo('content', newCard.content).limit(1);
            const existing = await query.find();
            if (existing.length > 0) return { success: false, msg: 'å¡å¯†å·²å­˜åœ¨' };

            const mcCard = new MCCard();
            mcCard.set('content', newCard.content);
            mcCard.set('type', newCard.type);
            mcCard.set('isUsed', false);
            await mcCard.save();

            const totalCount = await new AV.Query('MCCards').count();
            return { success: true, msg: 'å¡å¯†æ·»åŠ æˆåŠŸ', totalCount };
        }

        async function deleteCard(cardContent) {
            const query = new AV.Query('MCCards');
            query.equalTo('content', cardContent).limit(1);
            const target = await query.find();
            if (target.length === 0) return { success: false, msg: 'å¡å¯†ä¸å­˜åœ¨' };

            await AV.Object.destroyAll(target);
            const totalCount = await new AV.Query('MCCards').count();
            return { success: true, msg: 'å¡å¯†åˆ é™¤æˆåŠŸ', totalCount };
        }

        async function getAllCards() {
            const query = new AV.Query('MCCards');
            query.descending('createdAt').select('content', 'type', 'isUsed', 'createdAt');
            const allCards = await query.find();
            const formatted = allCards.map(card => ({
                content: card.get('content'),
                type: card.get('type'),
                isUsed: card.get('isUsed'),
                createTime: card.createdAt.toLocaleString()
            }));
            return { success: true, cards: formatted, totalCount: allCards.length };
        }

        // ======================
        // 6. æ¥å£å…¥å£ï¼ˆå¿«é€Ÿåˆ†å‘è¯·æ±‚ï¼Œä¼˜å…ˆå¤„ç†éªŒè¯ï¼‰
        // ======================
        async function handleApi() {
            if (handleCORS()) return;
            const request = parseRequest();
            if (!request || !request.action) {
                window.event.returnValue = JSON.stringify({
                    success: false,
                    msg: 'ç¼ºå°‘actionå‚æ•°ï¼ˆverify/writeCard/deleteCard/getAllCardsï¼‰'
                });
                return;
            }

            let response;
            try {
                // ä¼˜å…ˆå¤„ç†å¡å¯†éªŒè¯è¯·æ±‚
                switch (request.action) {
                    case 'verify':
                        response = await verifyCard(request.code);
                        break;
                    case 'writeCard':
                        response = await writeCard(request.card);
                        break;
                    case 'deleteCard':
                        response = await deleteCard(request.cardContent);
                        break;
                    case 'getAllCards':
                        response = await getAllCards();
                        break;
                    default:
                        response = { success: false, msg: `æœªçŸ¥åŠ¨ä½œï¼š${request.action}` };
                }
            } catch (err) {
                response = { success: false, msg: `äº‘ç«¯é”™è¯¯ï¼š${err.message}` };
            }

            window.event.returnValue = JSON.stringify(response);
        }

        // ä»…åœ¨POSTè¯·æ±‚æ—¶è§¦å‘ï¼ˆé¿å…é¡µé¢åŠ è½½æ‰§è¡Œï¼‰
        if (window.event && window.event.requestMethod === 'POST') {
            handleApi();
        }
    </script>
</body>
</html>
