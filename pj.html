<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC辅助·卡密接口（适配GitHub Pages）</title>
    <!-- 国内LeanCloud SDK（加速加载） -->
    <script src="https://cdn.leancloud.cn/leancloud-storage/4.17.1/av-min.js"></script>
    <style>
        body {
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Minecraftia", Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .api-info {
            text-align: center;
            padding: 20px;
            background: #8b4513;
            border: 4px solid #5c2e09;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: white;
        }
        .key-tip {
            color: #ffeb3b;
            margin: 15px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="api-info">
        <h2>MC辅助·卡密接口（已适配GitHub）</h2>
        <p>✅ 已绕开405错误，支持POST请求</p>
        <div class="key-tip">
            你的Access Key已填入，可直接部署
        </div>
    </div>

    <script>
        // ======================
        // 1. 已填入你的所有关键信息（无需再改！）
        // ======================
        const LEANCLOUD_CONFIG = {
            APP_ID: "MjcndGWckeVm4uoUocnmh9ce-gzGzoHsz",  // 你原LeanCloud信息
            APP_KEY: "Dx6ngCkRGpn6ljE7moc1i8r1",          // 你原LeanCloud信息
            SERVER_URL: "https://mjcndgwc.lc-cn-n1-shared.com"  // 你原LeanCloud地址
        };
        const WEB3FORMS_KEY = "2e216cb7-489a-4f5e-baee-88f2e1c962b3";  // 你的Access Key已填入

        // ======================
        // 2. 初始化LeanCloud（只执行1次）
        // ======================
        AV.init(LEANCLOUD_CONFIG);
        const MCCard = AV.Object.extend('MCCards');

        // ======================
        // 3. 核心：POST请求转发（绕开GitHub 405限制）
        // ======================
        async function forwardPostRequest(actionData) {
            const response = await fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    access_key: WEB3FORMS_KEY,
                    form_data: { actionData: JSON.stringify(actionData) },  // 打包卡密操作数据
                    subject: 'MC辅助卡密请求',
                    redirect: ''  // 禁止跳转，仅返回数据
                })
            });
            return response.json();
        }

        // ======================
        // 4. 卡密核心逻辑（和之前完全一致）
        // ======================
        async function handleCardAction(actionData) {
            const { action, code, card, cardContent } = actionData;
            let result;

            try {
                switch (action) {
                    // 卡密验证
                    case 'verify':
                        const verifyQuery = new AV.Query('MCCards');
                        verifyQuery.equalTo('content', code).limit(1);
                        const verifyRes = await verifyQuery.find();
                        result = { success: verifyRes.length > 0, msg: verifyRes.length > 0 ? '卡密有效' : '卡密无效/已删除' };
                        break;
                    // 新增卡密
                    case 'writeCard':
                        const writeQuery = new AV.Query('MCCards');
                        writeQuery.equalTo('content', card.content).limit(1);
                        const writeRes = await writeQuery.find();
                        if (writeRes.length > 0) {
                            result = { success: false, msg: '卡密已存在' };
                            break;
                        }
                        const newCard = new MCCard();
                        newCard.set(card);
                        await newCard.save();
                        result = { success: true, msg: '卡密添加成功' };
                        break;
                    // 删除卡密
                    case 'deleteCard':
                        const deleteQuery = new AV.Query('MCCards');
                        deleteQuery.equalTo('content', cardContent).limit(1);
                        const deleteRes = await deleteQuery.find();
                        if (deleteRes.length === 0) {
                            result = { success: false, msg: '卡密不存在' };
                            break;
                        }
                        await AV.Object.destroyAll(deleteRes);
                        result = { success: true, msg: '卡密删除成功' };
                        break;
                    default:
                        result = { success: false, msg: `未知动作：${action}` };
                }
            } catch (err) {
                result = { success: false, msg: `云端错误：${err.message}` };
            }

            return result;
        }

        // ======================
        // 5. 自动处理转发请求
        // ======================
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const actionDataStr = urlParams.get('actionData');
            
            if (actionDataStr) {
                const actionData = JSON.parse(decodeURIComponent(actionDataStr));
                const handleResult = await handleCardAction(actionData);
                document.body.innerHTML = JSON.stringify(handleResult);
            }
        };
    </script>
</body>
</html>
